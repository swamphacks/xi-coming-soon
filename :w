<script lang="ts">
	import Button from '$lib/components/button/Button.svelte';
	import Car from '$lib/components/car/Car.svelte';
	import Cloud from '$lib/components/cloud/Cloud.svelte';
	import Link from '$lib/components/link/Link.svelte';
	import Xbutton from '$lib/components/xbutton/Xbutton.svelte';

	const fetchUrl = "http://localhost:8080/events/368dd49d-fc69-444f-9f0e-d2ae75db95bb/interest";
	// TODO: hookup to simpler backend (and make sure validation is all good)
	// make server local copy of inputed emails for redundancy

	interface inputErrorType {
		error: string
		message: string
	}
	let error: inputErrorType;
	
	let showForm = $state(false);
	let inputEmail = $state("");
	let inputError = $state("");
	let inputSuccess = $state(false);
	let windowWidth = $state(0);

	const toggleForm = () => {
		showForm = !showForm;
	};
	
	const sendInterestRequest = async () => {
		inputSuccess = false;
		inputError = "";
		
		// TODO: Change link to prod site
		const res = await fetch(fetchUrl, {
			method: "POST",
			body: JSON.stringify({email: inputEmail, source: "Coming Soon Page"})
		});
		if (!res.ok) {
			error = await res.json();
			inputError = error.message;
		} else {
			inputSuccess = true;
		}
	}
</script>

{#if showForm}
	<div
		class="fixed z-2 w-full h-full flex flex-col items-center justify-center"
	>
		<div class="flex flex-col sm:w-auto justify-center bg-input-group rounded">
			<div class="flex flex-row gap-3 rounded p-6">
				<Xbutton on:click={toggleForm} class="mr-2">X</Xbutton>
				<!-- todo - x button placement -->
				<!-- form used to run subscribe button when enter key is pressed -->
				<form class="w-auto flex flex-col lg:flex-row flex-1 gap-3 justify-center items-center"> 
					<input
						type="email"
						bind:value={inputEmail}
						id="email-input"
						class="w-max lg:w-md rounded border-2 border-b-4 border-input-border bg-input p-4 text-xl lg:text-2xl font-bold text-input-text focus:border-input-focus-border"
						placeholder="email"
					/>
					<Button on:click={sendInterestRequest} class="px-auto lg:py-auto text-xl lg:text-2xl">Subscribe</Button>
				</form>
			</div>
			{#if inputError}
				<p class="text-red-500 text-md lg:text-lg text-center mb-2">{inputError}</p>
			{/if}
			{#if inputSuccess}
				<p class="text-green-500 text-md lg:text-lg text-center mb-2">Subscribed successfully.</p>
			{/if}

		</div>
	</div>
	<div class="z-1 min-h-full min-w-full bg-gray-800 opacity-50"></div>
{/if}

<svelte:window bind:innerWidth={windowWidth}/>
<div class="overflow-hidden min-w-full min-h-full w-full h-full">
	<div class="absolute top-[2vh] right-0 -z-1">
		<Cloud {windowWidth} />
		<Cloud {windowWidth} />
		<Cloud {windowWidth} /> 
		<Cloud {windowWidth} /> 
	</div>
	<div class="flex min-h-screen flex-col items-center justify-center gap-3">
		<p class="title-text m-4 sm:m-6 text-6xl sm:text-7xl lg:text-8xl font-bold tracking-wide text-header">Coming soon</p>
		<div class="flex flex-row gap-3">
			<Button on:click={toggleForm} class="text-md sm:text-xl lg:text-3xl">Sign up for updates</Button>
			<Link href="https://x.swamphacks.com/recap"><Button class="text-md sm:text-xl lg:text-3xl">SH X Recap</Button></Link
			>
		</div>
		<Link href="mailto:finance@swamphacks.com"
			><Button class="text-sm sm:text-md lg:text-xl">Interested in becoming a sponsor?</Button></Link
		>
	</div>
	<div class="absolute left-[3vw] bottom-[1vh] -z-1">
		<Car class="w-64 lg:w-96" />
	</div>
	<div class="absolute bottom-0 min-w-full h-[2vh] bg-header -z-2"></div>
</div>
